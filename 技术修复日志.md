# LangGraph API ç§æœ‰åŒ–æ”¹é€ æŠ€æœ¯ä¿®å¤æ—¥å¿—

## ä¿®å¤æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†åœ¨ LangGraph API ç§æœ‰åŒ–æ”¹é€ è¿‡ç¨‹ä¸­é‡åˆ°çš„æŠ€æœ¯é—®é¢˜å’Œå¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼Œä¸ºåç»­ç»´æŠ¤å’Œå¼€å‘æä¾›å‚è€ƒã€‚

## é—®é¢˜1ï¼šURL æ„é€ é”™è¯¯

### é—®é¢˜æè¿°
**é”™è¯¯ä¿¡æ¯**ï¼š`Error: Failed to construct 'URL': Invalid URL`

**å‘ç”Ÿä½ç½®**ï¼š
- `src/components/thread/index.tsx` (handleSubmit å‡½æ•°)
- çº¿ç¨‹åˆ›å»ºå’Œæ¶ˆæ¯å‘é€è¿‡ç¨‹

**æ ¹æœ¬åŸå› **ï¼š
LangGraph SDK æœŸæœ›æ¥æ”¶å®Œæ•´çš„ URLï¼ˆå¦‚ `https://example.com/api`ï¼‰ï¼Œä½†æˆ‘ä»¬ä¼ é€’çš„æ˜¯ç›¸å¯¹è·¯å¾„ `/api`ã€‚å½“ SDK å°è¯•ä½¿ç”¨ `new URL("/api")` æ„é€  URL å¯¹è±¡æ—¶å¤±è´¥ã€‚

### è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/providers/Stream.tsx`
- `src/providers/Thread.tsx`

**æ ¸å¿ƒä¿®å¤ä»£ç **ï¼š
```typescript
// ä¿®æ”¹å‰
const finalApiUrl = "/api";

// ä¿®æ”¹å
const finalApiUrl = typeof window !== 'undefined' 
  ? `${window.location.origin}/api`
  : "/api";
```

**æŠ€æœ¯ç»†èŠ‚**ï¼š
- åœ¨å®¢æˆ·ç«¯ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ `window.location.origin` æ„é€ å®Œæ•´ URL
- åœ¨æœåŠ¡ç«¯ç¯å¢ƒä¸­ï¼Œä¿æŒç›¸å¯¹è·¯å¾„ä½œä¸ºå›é€€å€¼
- ç¡®ä¿ SSR å’Œå®¢æˆ·ç«¯æ¸²æŸ“éƒ½èƒ½æ­£å¸¸å·¥ä½œ

## é—®é¢˜2ï¼šå†å²å¯¹è¯æ— æ³•åŠ è½½

### é—®é¢˜æè¿°
**ç—‡çŠ¶**ï¼š
- å†å²å¯¹è¯ä¾§è¾¹æ æ˜¾ç¤ºä¸ºç©º
- API è¯·æ±‚æˆåŠŸä½†ä¸æ˜¾ç¤ºå†…å®¹
- æ§åˆ¶å°æ— æ˜æ˜¾é”™è¯¯

**æ ¹æœ¬åŸå› **ï¼š
`ThreadProvider` ä¸­çš„ `assistantId` å‚æ•°æ²¡æœ‰è®¾ç½®é»˜è®¤å€¼ï¼Œå¯¼è‡´ï¼š
1. URL å‚æ•°ä¸ºç©ºæ—¶ï¼Œ`assistantId` ä¸º `null` æˆ– `undefined`
2. `getThreads` å‡½æ•°ä¸­çš„ `if (!assistantId) return []` å¯¼è‡´æ—©æœŸè¿”å›
3. çº¿ç¨‹æœç´¢è¯·æ±‚ä»æœªå‘é€

### è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/providers/Thread.tsx`
- `src/components/thread/history/index.tsx`

**1. æ·»åŠ é»˜è®¤å€¼å’Œç¯å¢ƒå˜é‡å¤„ç†**ï¼š
```typescript
// æ·»åŠ é»˜è®¤å€¼å¸¸é‡
const DEFAULT_ASSISTANT_ID = "agent";

// è·å–ç¯å¢ƒå˜é‡
const envAssistantId: string | undefined = process.env.NEXT_PUBLIC_ASSISTANT_ID;

// è®¾ç½®æŸ¥è¯¢å‚æ•°é»˜è®¤å€¼
const [assistantId] = useQueryState("assistantId", {
  defaultValue: envAssistantId || "",
});
```

**2. ä¿®å¤å›é€€é€»è¾‘**ï¼š
```typescript
// åœ¨ getThreads å‡½æ•°ä¸­
const finalAssistantId = assistantId || envAssistantId || DEFAULT_ASSISTANT_ID;

if (!finalAssistantId) return [];
```

**3. ä¿®å¤ä¾èµ–é¡¹**ï¼š
```typescript
// ThreadHistory ç»„ä»¶ä¸­
useEffect(() => {
  // é‡æ–°è·å–æ•°æ®
}, [getThreads]); // æ·»åŠ  getThreads åˆ°ä¾èµ–é¡¹
```

## é—®é¢˜3ï¼šç»„ä»¶çŠ¶æ€ä¸ä¸€è‡´

### é—®é¢˜æè¿°
**ç—‡çŠ¶**ï¼š
- `StreamProvider` å’Œ `ThreadProvider` ä½¿ç”¨ä¸åŒçš„é»˜è®¤å€¼é€»è¾‘
- ç¯å¢ƒå˜é‡å¤„ç†æ–¹å¼ä¸ä¸€è‡´
- å¯èƒ½å¯¼è‡´æ•°æ®ä¸åŒæ­¥

### è§£å†³æ–¹æ¡ˆ

**ç»Ÿä¸€åŒ–å¤„ç†**ï¼š
1. **ç›¸åŒçš„é»˜è®¤å€¼å¸¸é‡**ï¼š
   ```typescript
   const DEFAULT_ASSISTANT_ID = "agent";
   ```

2. **ç›¸åŒçš„ç¯å¢ƒå˜é‡è·å–**ï¼š
   ```typescript
   const envAssistantId: string | undefined = process.env.NEXT_PUBLIC_ASSISTANT_ID;
   ```

3. **ç›¸åŒçš„å›é€€é€»è¾‘**ï¼š
   ```typescript
   const finalAssistantId = assistantId || envAssistantId || DEFAULT_ASSISTANT_ID;
   ```

4. **ç›¸åŒçš„URLæ„é€ æ–¹å¼**ï¼š
   ```typescript
   const finalApiUrl = typeof window !== 'undefined' 
     ? `${window.location.origin}/api`
     : "/api";
   ```

## é—®é¢˜4ï¼šå·²ç§»é™¤åŠŸèƒ½çš„æ¸…ç†

### é—®é¢˜æè¿°
**ç—‡çŠ¶**ï¼š
- ä»£ç ä¸­ä»ç„¶å¼•ç”¨å·²ç§»é™¤çš„ `apiUrl` æŸ¥è¯¢å‚æ•°
- "Open in Studio" åŠŸèƒ½åœ¨ç§æœ‰åŒ–éƒ¨ç½²ä¸­ä¸å¯ç”¨

### è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `src/components/thread/agent-inbox/components/thread-actions-view.tsx`

**æ¸…ç†æ­¥éª¤**ï¼š
1. **ç§»é™¤è¿‡æ—¶çš„æŸ¥è¯¢å‚æ•°**ï¼š
   ```typescript
   // ç§»é™¤
   const [apiUrl] = useQueryState("apiUrl");
   ```

2. **ç¦ç”¨ä¸å…¼å®¹åŠŸèƒ½**ï¼š
   ```typescript
   // æ³¨é‡Šæ‰ handleOpenInStudio å‡½æ•°å’Œç›¸å…³UI
   /*
   const handleOpenInStudio = () => {
     // ...
   };
   */
   ```

3. **æ·»åŠ è¯´æ˜æ³¨é‡Š**ï¼š
   ```typescript
   // Disable "Open in Studio" functionality for private deployment
   // since users cannot access the external LangGraph server directly
   ```

## éªŒè¯å’Œæµ‹è¯•

### åŠŸèƒ½éªŒè¯
å®Œæˆä¿®å¤åï¼Œä»¥ä¸‹åŠŸèƒ½æ­£å¸¸å·¥ä½œï¼š

1. **æ¶ˆæ¯å‘é€å’Œæ¥æ”¶** âœ…
   ```
   POST /api/threads/[id]/runs/stream 200 in XXXms
   ```

2. **å†å²å¯¹è¯åŠ è½½** âœ…
   ```
   POST /api/threads/search 200 in XXXms
   ```

3. **API ä»£ç†å·¥ä½œ** âœ…
   ```
   ğŸ”’ Secure API proxy initialized successfully
   ğŸ“¡ Target server: [CONFIGURED]
   ```

### æ€§èƒ½æŒ‡æ ‡
- API ä»£ç†å“åº”æ—¶é—´ï¼š< 1000ms
- çº¿ç¨‹æœç´¢å»¶è¿Ÿï¼š< 900ms
- æ¶ˆæ¯æµä¼ è¾“ï¼šå®æ—¶å“åº”
- é¡µé¢åŠ è½½æ—¶é—´ï¼š< 5s

## æœ€ä½³å®è·µæ€»ç»“

### 1. URL å¤„ç†
```typescript
// æ¨èï¼šå¤„ç†ç›¸å¯¹è·¯å¾„åˆ°ç»å¯¹è·¯å¾„çš„è½¬æ¢
const apiUrl = typeof window !== 'undefined' 
  ? `${window.location.origin}/api`
  : "/api";
```

### 2. é»˜è®¤å€¼å¤„ç†
```typescript
// æ¨èï¼šå¤šå±‚å›é€€æœºåˆ¶
const finalValue = urlParam || envVar || DEFAULT_VALUE;
```

### 3. ä¾èµ–é¡¹ç®¡ç†
```typescript
// æ¨èï¼šæ˜ç¡®æŒ‡å®šæ‰€æœ‰ä¾èµ–é¡¹
useEffect(() => {
  // ä¸šåŠ¡é€»è¾‘
}, [dependency1, dependency2]);
```

### 4. ç¯å¢ƒå˜é‡ä½¿ç”¨
```typescript
// æ¨èï¼šç»Ÿä¸€çš„ç¯å¢ƒå˜é‡è·å–æ–¹å¼
const envVar: string | undefined = process.env.NEXT_PUBLIC_VAR_NAME;
```

## é¢„é˜²æªæ–½

### 1. ä»£ç å®¡æŸ¥æ£€æŸ¥ç‚¹
- [ ] URL æ„é€ æ˜¯å¦ä½¿ç”¨å®Œæ•´è·¯å¾„
- [ ] é»˜è®¤å€¼æ˜¯å¦æ­£ç¡®è®¾ç½®
- [ ] ç¯å¢ƒå˜é‡å¤„ç†æ˜¯å¦ä¸€è‡´
- [ ] ä¾èµ–é¡¹æ˜¯å¦å®Œæ•´

### 2. æµ‹è¯•æ¸…å•
- [ ] æ¶ˆæ¯å‘é€åŠŸèƒ½
- [ ] å†å²å¯¹è¯åŠ è½½
- [ ] è®¾ç½®ä¿å­˜å’Œæ¢å¤
- [ ] é”™è¯¯å¤„ç†
- [ ] ç½‘ç»œè¯·æ±‚è·¯å¾„

### 3. éƒ¨ç½²éªŒè¯
- [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
- [ ] API ä»£ç†æ—¥å¿—æ­£å¸¸
- [ ] å®¢æˆ·ç«¯æ— é”™è¯¯
- [ ] åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•

## é—®é¢˜æ’æŸ¥æŒ‡å—

### 1. URL æ„é€ é—®é¢˜
**ç—‡çŠ¶**ï¼š`Failed to construct 'URL'` é”™è¯¯
**æ£€æŸ¥**ï¼š
```typescript
console.log('API URL:', finalApiUrl);
// åº”è¯¥è¾“å‡ºå®Œæ•´URLï¼Œå¦‚ï¼šhttp://localhost:3000/api
```

### 2. é»˜è®¤å€¼é—®é¢˜
**ç—‡çŠ¶**ï¼šæ•°æ®åŠ è½½å¤±è´¥ï¼Œå‚æ•°ä¸ºç©º
**æ£€æŸ¥**ï¼š
```typescript
console.log('Assistant ID:', finalAssistantId);
// åº”è¯¥æœ‰å€¼ï¼Œå¦‚ï¼šagent
```

### 3. ä¾èµ–é¡¹é—®é¢˜
**ç—‡çŠ¶**ï¼šæ•°æ®ä¸æ›´æ–°ï¼ŒuseEffect ä¸è§¦å‘
**æ£€æŸ¥**ï¼š
```typescript
useEffect(() => {
  console.log('Effect triggered');
  // åº”è¯¥åœ¨ä¾èµ–é¡¹å˜åŒ–æ—¶è¾“å‡º
}, [dependency]);
```

## ç›¸å…³æ–‡æ¡£

- [ç§æœ‰åŒ–æ”¹é€ æ€»ç»“.md](./ç§æœ‰åŒ–æ”¹é€ æ€»ç»“.md)
- [PRIVATE_DEPLOYMENT.md](./PRIVATE_DEPLOYMENT.md)
- [API ä»£ç†å®ç°](./src/app/api/[..._path]/route.ts)

## æ›´æ–°å†å²

- **2025-01-XX**: åˆå§‹ç‰ˆæœ¬ï¼Œè®°å½•URLæ„é€ å’Œå†å²å¯¹è¯é—®é¢˜
- **2025-01-XX**: æ·»åŠ ç»„ä»¶ä¸€è‡´æ€§å’ŒåŠŸèƒ½æ¸…ç†å†…å®¹
- **2025-01-XX**: è¡¥å……éªŒè¯æµ‹è¯•å’Œæœ€ä½³å®è·µ

---

**æ³¨æ„**ï¼šæœ¬æ–‡æ¡£è®°å½•çš„ä¿®å¤æ–¹æ¡ˆé€‚ç”¨äºå½“å‰ç‰ˆæœ¬ï¼Œå¦‚æœ‰é‡å¤§æ¶æ„å˜æ›´ï¼Œè¯·åŠæ—¶æ›´æ–°æœ¬æ–‡æ¡£ã€‚ 